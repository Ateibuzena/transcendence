# Define grupos de servidores backend para balanceo de carga
upstream auth-service {
    server auth-service:5001;
}

upstream user-service {
    server user-service:5002;
}

upstream chat-service {
    server chat-service:5003;
}

upstream game-service {
    server game-service:5004;
}

upstream rt-gateway {
    server rt-gateway:6001;
}

server {
    # Escucha en el puerto 80 para solicitudes HTTP
    listen 80;
    # Acepta solicitudes para este hostname
    server_name localhost;

    # Tamaño máximo permitido para el cuerpo de las solicitudes (uploads, POST)
    client_max_body_size 10M;
    # Tamaño del buffer para leer el cuerpo de la solicitud
    client_body_buffer_size 128k;

    # Archivo donde se registran los accesos
    access_log /var/log/nginx/access.log;
    # Archivo donde se registran los errores
    error_log /var/log/nginx/error.log;

    # Endpoint de salud para monitoreo/balanceadores
    location /health {
        # No registrar solicitudes al endpoint de salud
        access_log off;
        # Responder HTTP 200 con cuerpo "OK"
        return 200 "OK\n";
        # Establecer cabecera Content-Type
        add_header Content-Type text/plain;
    }

    # ===========================
    # RUTAS DEL AUTH SERVICE
    # ===========================
    location /auth-service/ {
        # Redirigir solicitudes al auth service, quitando el prefijo /auth-service
        proxy_pass http://auth-service/;
        # Pasar el encabezado Host original al backend
        proxy_set_header Host $host;
        # Pasar la IP original del cliente
        proxy_set_header X-Real-IP $remote_addr;
        # Pasar la cadena de IPs del proxy
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Pasar el protocolo original (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Tiempo máximo para establecer conexión con el backend
        proxy_connect_timeout 60s;
        # Tiempo máximo para enviar la solicitud al backend
        proxy_send_timeout 60s;
        # Tiempo máximo para recibir respuesta del backend
        proxy_read_timeout 60s;
    }

    # ===========================
    # RUTAS DEL USER SERVICE
    # ===========================
    location /user-service/ {
        # Redirigir solicitudes al user service, quitando el prefijo /user-service
        proxy_pass http://user-service/;
        # Pasar el encabezado Host original al backend
        proxy_set_header Host $host;
        # Pasar la IP original del cliente
        proxy_set_header X-Real-IP $remote_addr;
        # Pasar la cadena de IPs del proxy
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Pasar el protocolo original (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Tiempo máximo para establecer conexión con el backend
        proxy_connect_timeout 60s;
        # Tiempo máximo para enviar la solicitud al backend
        proxy_send_timeout 60s;
        # Tiempo máximo para recibir respuesta del backend
        proxy_read_timeout 60s;
    }

    # ===========================
    # RUTAS DEL CHAT SERVICE
    # ===========================
    location /chat-service/ {
        # Redirigir solicitudes al chat service, quitando el prefijo /chat-service
        proxy_pass http://chat-service/;
        # Pasar el encabezado Host original al backend
        proxy_set_header Host $host;
        # Pasar la IP original del cliente
        proxy_set_header X-Real-IP $remote_addr;
        # Pasar la cadena de IPs del proxy
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Pasar el protocolo original (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Tiempo máximo para establecer conexión con el backend
        proxy_connect_timeout 60s;
        # Tiempo máximo para enviar la solicitud al backend
        proxy_send_timeout 60s;
        # Tiempo máximo para recibir respuesta del backend
        proxy_read_timeout 60s;
    }

    # ===========================
    # RUTAS DEL GAME SERVICE
    # ===========================
    location /game-service/ {
        # Redirigir solicitudes al game service, quitando el prefijo /game-service
        proxy_pass http://game-service/;
        # Pasar el encabezado Host original al backend
        proxy_set_header Host $host;
        # Pasar la IP original del cliente
        proxy_set_header X-Real-IP $remote_addr;
        # Pasar la cadena de IPs del proxy
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Pasar el protocolo original (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Tiempo máximo para establecer conexión con el backend
        proxy_connect_timeout 60s;
        # Tiempo máximo para enviar la solicitud al backend
        proxy_send_timeout 60s;
        # Tiempo máximo para recibir respuesta del backend
        proxy_read_timeout 60s;
    }

    # ===========================
    # REAL-TIME GATEWAY (Soporte WebSocket)
    # ===========================
    location /rt-gateway/ {
        # Redirigir solicitudes al rt-gateway, quitando el prefijo /rt-gateway
        proxy_pass http://rt-gateway/;
        # Pasar el encabezado Host original al backend
        proxy_set_header Host $host;
        # Pasar la IP original del cliente
        proxy_set_header X-Real-IP $remote_addr;
        # Pasar la cadena de IPs del proxy
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Pasar el protocolo original (http/https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Usar HTTP/1.1 para soporte WebSocket
        proxy_http_version 1.1;
        # Pasar encabezado Upgrade para WebSockets
        proxy_set_header Upgrade $http_upgrade;
        # Establecer Connection: "upgrade" para WebSocket
        proxy_set_header Connection "upgrade";
        
        # Desactivar el buffering para streaming en tiempo real
        proxy_buffering off;
        
        # Tiempo máximo para establecer conexión WebSocket (7 días)
        proxy_connect_timeout 7d;
        # Tiempo máximo entre escrituras (7 días)
        proxy_send_timeout 7d;
        # Tiempo máximo entre lecturas (7 días)
        proxy_read_timeout 7d;
    }

    # Ruta por defecto para paths no definidos
    location / {
        # Responder con HTTP 404 y mensaje JSON
        return 404 '{"error": "Route not found"}';
        # Establecer Content-Type como JSON
        add_header Content-Type application/json;
    }
}
